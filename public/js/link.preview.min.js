/* 
* Copyright (c) 2012 Leonardo Cardoso (http://leocardz.com)
* Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
* and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
*
* Version: 0.4.47
* 
*/
(function ($) {
	$.fn.linkPreview = function(){
		
		function trim(str) {
			return str.replace(/^\s+|\s+$/g,"");
		}
		
		var text;
		var urlRegex = /(https?\:\/\/|\s)[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})(\/+[a-z0-9_.\:\;-]*)*(\?[\&\%\|\+a-z0-9_=,\.\:\;-]*)?([\&\%\|\+&a-z0-9_=,\:\;\.-]*)([\!\#\/\&\%\|\+a-z0-9_=,\:\;\.-]*)}*/i;
		
		$(this).keyup(function(e){
			if((e.which == 13 || e.which == 32 || e.which == 17) && trim( $(this).val() ) != ""){
				
				text = $(this).val();
				
				if( urlRegex.test(text)){
					
					$('#previewLoading').html("<img src='img/link-preview/loader.gif' ></img>");
					
					$.get('text_crawler', {text: text}, function(answer) {
						
						if(answer.url == null) answer.url = "";
						if(answer.pageUrl == null) answer.pageUrl = "";
						if(answer.title == null) answer.title = answer.titleEsc;
						if(answer.description == null) answer.description = answer.descriptionEsc;
						if(answer.title == null) answer.title = "";
						if(answer.description == null) answer.description = "";
						if(answer.cannonicalUrl == null) answer.cannonicalUrl = "";
						if(answer.images == null) answer.images = "";
						if(answer.video == null) answer.video = "";
						if(answer.videoIframe == null) answer.videoIframe = "";
						
						var e_title = answer.title.substr(0, 40);
						var e_desc = answer.description.substr(0, 150);
						e_title = e_title + ( e_title != answer.title ? '...' : '' );
						e_desc = e_desc + ( e_desc != answer.description ? '...' : '' );
						
						var result = 
							'url => ' + answer.url + '<br/><br/>' +
							'title => ' + e_title + '<br/><br/>' +
							'desc => ' + e_desc + '<br/><br/>' +
							'images => ' + answer.images + '<br/><br/>' + 
							'video => ' + answer.video + '\n\n';
							
						$('#link_preview_data').html( result );
						$('#previewLoading').html("");
						
					}, "json");
				}
				
			}
		});


	}
})(jQuery);